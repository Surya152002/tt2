<!DOCTYPE html>
<html>
<head>
	<title>Beta Sensor Value</title>
	<style>
		#sensorCanvas {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<canvas id="sensorCanvas"></canvas>
	<button id="startButton">Start</button>

	<script>
		const canvas = document.getElementById("sensorCanvas");
		const ctx = canvas.getContext("2d");
		ctx.font = "15px Arial";
		let startTime = 0;
		let endTime = 0;
		let prevBeta = 0;
		let hasProperSeating = false;
		let eventListenerAdded = false;
		
		// create a new WebSocket object
		const socket = new WebSocket('ws://192.168.1.39:8080');

		socket.addEventListener('open', function (event) {
		    console.log('WebSocket is connected.');
		});

		socket.addEventListener('message', function (event) {
		    console.log('Message from server ', event.data);
		});

		function updateCanvas(beta) {
			// Clear the canvas
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			const roundedBeta = Math.round(beta);

			if (roundedBeta < 80) {
				const message = `Proper Seating: Beta value ${roundedBeta}`;
				ctx.fillText(message, 10, 50);
				socket.send(message);
				startTime = 0;
				endTime = 0;
				prevBeta = roundedBeta;
				hasProperSeating = true;
			} else if (roundedBeta >= 80 && roundedBeta <= 87) {
				if (!hasProperSeating) {
					const message = `Proper Seating Required`;
					ctx.fillText(message, 10, 50);
					socket.send(message);
				} else if (prevBeta < 80 || prevBeta > 87) {
					const message = `Intermediate Position: Beta value ${roundedBeta}`;
					ctx.fillText(message, 10, 50);
					socket.send(message);
					startTime = new Date().getTime();
					endTime = 0;
				} else {
					endTime = new Date().getTime();
					const timeDiff = (endTime - startTime) / 1000;

					if (timeDiff > 60) {
						const message = `User not properly seated`;
						ctx.fillText(message, 10, 150);
						socket.send(message);
					} else {
						const message = `Intermediate Position: Beta value ${roundedBeta}, Time: ${timeDiff.toFixed(2)} seconds`;
						ctx.fillText(message, 10, 50);
						socket.send(message);
					}
				}
				prevBeta = roundedBeta;
			} else {
				const message = `Initial Seating: Beta value ${roundedBeta}`;
				ctx.fillText(message, 10, 50);
				socket.send(message);
				startTime = 0;
				endTime = 0;
				prevBeta = roundedBeta;
				hasProperSeating = false;
			}
		}

		function startEventListeners() {
			window.addEventListener("deviceorientation", deviceOrientationHandler);
			eventListenerAdded = true;
		}

		window.addEventListener("deviceorientation", (event) => {
			const beta = event.beta;
			updateCanvas(beta);
		});
	</script>
</body>
</html>
