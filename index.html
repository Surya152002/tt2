<!DOCTYPE html>
<html>
<head>
  <title>Beta Sensor Value</title>
  <style>
    #sensorCanvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="statusIndicator"></div>

  <!-- Existing HTML code... -->
	<div id="statusIndicator"></div>
	<div id="betaValue">Beta Value: --</div>
	<div id="flagValue">Flag Value: --</div>
	<div id="statusMessage">Status: --</div>
	<canvas id="sensorCanvas"></canvas>
<!-- ... -->


  <script>
    const canvas = document.getElementById("sensorCanvas");
    const ctx = canvas.getContext("2d");
    ctx.font = "15px Arial";

    

    let startTime = 0;
    let endTime = 0;
    let prevBeta = 0;
    let hasProperSeating = false;
    let eventListenerAdded = false;

    // Newly introduced variables
    let initialPosition = null;
    let breakStartTime = 0;
    let flag = 0;  // initial flag value is 0

    // WebSocket connection to the server
    const ws = new WebSocket("ws://192.168.30.213:3000"); // Replace with your laptop's IP address

    // Function to update the status indicator
    function updateStatusIndicator(connected) {
      const statusIndicator = document.getElementById("statusIndicator");
      if (connected) {
        statusIndicator.textContent = "Connected to Server";
        statusIndicator.style.color = "green";
      } else {
        statusIndicator.textContent = "Not Connected to Server";
        statusIndicator.style.color = "red";
      }
    }

    // Modified updateCanvas function
    function updateCanvas(beta) {
      // Clear the canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Round the beta value to the nearest integer
      const roundedBeta = Math.round(beta);

      // Assuming a specific beta range indicates a stationary position
      const isStationary = beta >= 80 && beta <= 100;

      if (isStationary) {
        if (initialPosition === null) {
          initialPosition = beta;
          breakStartTime = Date.now();
        }
        
        // Check if 10 seconds have passed while in a stationary position
        if (Date.now() - breakStartTime >= 10000) {
          if (flag !== 1) {
            flag = 1;
            console.log('User is taking a break');
          }
        }
      } else {
        if (initialPosition !== null) {
          initialPosition = null;
          breakStartTime = 0;
          if (flag !== 2) {
            flag = 2;
            console.log('User came back to sitting position');
          }
        }
      }
	const betaElement = document.getElementById("betaValue");
    const flagElement = document.getElementById("flagValue");
    const statusElement = document.getElementById("statusMessage");

    // Update the HTML elements with the current beta and flag values
    betaElement.textContent = `Beta Value: ${beta}`;
    flagElement.textContent = `Flag Value: ${flag}`;
    
    // Determine the status message based on the flag value
    let statusMessage = 'Status: --';
    if (flag === 1) {
        statusMessage = 'Status: User is taking a break';
    } else if (flag === 2) {
        statusMessage = 'Status: User came back to sitting position';
    }
    
    // Update the status message element
    statusElement.textContent = statusMessage;
      if (roundedBeta < 80) {
				// Display message for proper seating
				ctx.fillText(`Proper Seating: Beta value ${roundedBeta}`, 10, 50);

				// Reset time tracking variables
				startTime = 0;
				endTime = 0;
				prevBeta = roundedBeta;
				hasProperSeating = true;
			} else if (roundedBeta >= 80 && roundedBeta <= 87) {
				if (!hasProperSeating) {
					// Display message for proper seating first
					ctx.fillText(`Proper Seating Required`, 10, 50);
				} else if (prevBeta < 80 || prevBeta > 87) {
					// Display message for intermediate position
					ctx.fillText(`Intermediate Position: Beta value ${roundedBeta}`, 10, 50);

					// Start tracking time
					startTime = new Date().getTime();
					endTime = 0;
				} else {
					// Continue tracking time
					endTime = new Date().getTime();
					const timeDiff = (endTime - startTime) / 1000;

					if (timeDiff > 60) {
						// Display message if time exceeds 60 seconds
						ctx.fillText(`User not properly seated`, 10, 150);
					} else {
						// Display time message
						const timeMessage = `Time: ${timeDiff.toFixed(2)} seconds`;
						ctx.fillText(`Intermediate Position: Beta value ${roundedBeta}`, 10, 50);
						ctx.fillText(timeMessage, 10, 100);
					}
				}

				// Update previous beta value
				prevBeta = roundedBeta;
			} else {
				// Display message for proper seating ///fuoghsudoghruoghsuhou
				ctx.fillText(`Initial Seating: Beta value ${roundedBeta}`, 10, 50);

				// Reset time tracking variables
				startTime = 0;
				endTime = 0;
				prevBeta = roundedBeta;
				hasProperSeating = false;
			}

      // Send the sensor value to the server along with the flag value
      ws.send(JSON.stringify({ sensorValue: beta, flag: flag }));
    }

    // Function to start the event listeners
    function startEventListeners() {
      window.addEventListener("deviceorientation", deviceOrientationHandler);
      eventListenerAdded = true;
    }

    // Event listener for device orientation change
    function deviceOrientationHandler(event) {
      // Get the beta value from the sensor data
      const beta = event.beta;

      // Update the canvas with the beta value
      updateCanvas(beta);
    }

    // Ensure event listeners are started once the page is loaded
    window.addEventListener("load", () => {
      if (!eventListenerAdded) {
        startEventListeners();
      }
    });

    // WebSocket event handlers
    ws.addEventListener("open", () => {
      // Connection to the server is open
      updateStatusIndicator(true);
    });

    ws.addEventListener("close", () => {
      // Connection to the server is closed
      updateStatusIndicator(false);
    });

    ws.addEventListener("message", (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.sensorValue !== undefined) {
          // Update the canvas with the sensor value received from the server
          updateCanvas(data.sensorValue);
        }
      } catch (error) {
        console.error("Error parsing message:", error);
      }
    });
  </script>
</body>
</html>
